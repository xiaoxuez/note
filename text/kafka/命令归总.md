## Kafka


[å®˜æ–¹æ–‡æ¡£](http://kafka.apache.org/documentation/)

### ç›¸å…³æ“ä½œ

```
	//å¯åŠ¨server
	bin/kafka-server-start.sh config/server.properties
	
	// create topic
	bin/kafka-topics.sh --create --zookeeper localhost:2181 --replication-factor 1 --partitions 1 --topic test
	
	//list topic
	bin/kafka-topics.sh --list --zookeeper localhost:2181
	
	//produce msg to topic test
	bin/kafka-console-producer.sh --broker-list localhost:9092 --topic test
	
	//a command line consumer
	bin/kafka-console-consumer.sh --bootstrap-server localhost:9092 --topic test --from-beginning
	
	// describe topic, result includes Leader,PartitionCount, Partition...
	bin/kafka-topics.sh --describe --zookeeper localhost:2181 --topic my-replicated-topic
	
	//delete
	bin/kafka-topics.sh  --zookeeper  localhost:2181 --delete --topic tt
	
	//comsumer for key-value
	bin/kafka-console-consumer.sh --bootstrap-server localhost:9092 --topic WordsWithCountsTopic --from-beginning           --formatter kafka.tools.DefaultMessageFormatter           --property print.key=true           --property key.deserializer=org.apache.kafka.common.serialization.StringDeserializer           --property value.deserializer=org.apache.kafka.common.serialization.LongDeserializer
	
	//æŸ¥çœ‹topicåˆ†å¸ƒæƒ…å†µkafka-list-topic.sh
	bin/kafka-list-topic.sh --zookeeper 192.168.197.170:2181,192.168.197.171:2181 ï¼ˆåˆ—å‡ºæ‰€æœ‰topicçš„åˆ†åŒºæƒ…å†µï¼‰
	bin/kafka-list-topic.sh --zookeeper 192.168.197.170:2181,192.168.197.171:2181 --topic test ï¼ˆæŸ¥çœ‹testçš„åˆ†åŒºæƒ…å†µï¼‰
	
	//é‡æ–°åˆ†é…åˆ†åŒºkafka-reassign-partitions.sh
	//è¿™ä¸ªå‘½ä»¤å¯ä»¥åˆ†åŒºæŒ‡å®šåˆ°æƒ³è¦çš„--broker-listä¸Š
	bin/kafka-reassign-partitions.sh --topics-to-move-json-file topics-to-move.json --broker-list "171" --zookeeper 192.168.197.170:2181,192.168.197.171:2181 --execute 
	
	//ä¸ºTopicå¢åŠ  partitionæ•°ç›®kafka-add-partitions.sh
	bin/kafka-add-partitions.sh --topic test --partition 2  --zookeeper  192.168.197.170:2181,192.168.197.171:2181 ï¼ˆä¸ºtopic testå¢åŠ 2ä¸ªåˆ†åŒºï¼‰
	
	//æ‰‹åŠ¨å‡è¡¡topic, kafka-preferred-replica-election.sh
	
```

+ Kafkaå…è®¸topicçš„åˆ†åŒºæ‹¥æœ‰è‹¥å¹²å‰¯æœ¬, å¯ä»¥ä¸ºæ¯ä¸ªtopicé…ç½®å‰¯æœ¬çš„æ•°é‡(--replication-factor)ã€‚åˆ›å»ºå‰¯æœ¬çš„å•ä½æ˜¯topicçš„åˆ†åŒºï¼Œæ¯ä¸ªåˆ†åŒºéƒ½æœ‰ä¸€ä¸ªLeaderå’Œé›¶æˆ–å¤šä¸ªfollowers,æ‰€æœ‰çš„è¯»å†™æ“ä½œéƒ½ç”±leaderå¤„ç†ï¼ŒleaderæŒ‚æ‰ä¹‹åï¼Œå°±ä¼šåœ¨followersä¸­é€‰æ‹©æ–°çš„leaderã€‚[è¯¦ç»†ä»‹ç»](http://www.infoq.com/cn/articles/kafka-analysis-part-2/)



### ç¤ºä¾‹åˆ†æ-Kafka-stream

+ WordCountLambdaExampleã€‚å•è¯è®¡æ•°ï¼Œç›¸å…³Apiæ˜¯

		  final KStreamBuilder builder = new KStreamBuilder();
			//æ¥æº, key-value-topic
		  final KStream<String, String> textLines = builder.stream(stringSerde, stringSerde, "testTopic");
		  final KTable<String, Long> wordCounts = textLines
	     	      .flatMapValues(value -> Arrays.asList(pattern.split(value.toLowerCase())))
	     	      .groupBy((key, word) -> word)
	      .count("Counts");
	      //flatMapï¼Œä¼šæŠŠå­é›†åˆçš„æ•°æ®å‹ç¼©åˆ°çˆ¶é›†åˆä¸­ï¼Œå°±æ˜¯keyä¸å˜ï¼Œvalueå˜åŒ–
	      //å»å‘, key-value-topic
	       wordCounts.to(stringSerde, longSerde, "WordsWithCountsTopic");
	       final KafkaStreams streams = new KafkaStreams(builder, streamsConfiguration);
	       streams.cleanUp();
    	   streams.start();
    	   
    	   // Add shutdown hook to respond to SIGTERM and gracefully close Kafka Streams
   			Runtime.getRuntime().addShutdownHook(new Thread(streams::close));
   			
+ WikipediaFeedAvroLambdaExample, ç±»ä¼¼å•è¯è®¡æ•°ã€‚è·ŸWordCountLambdaExampleçš„å·®åˆ«å¦‚ä¸‹ï¼š
	1. æ¥æºæ ¼å¼ä¸ç®€å•ï¼Œvalueä¸ºAvroæ ¼å¼ï¼Œæ‰€ä»¥è®¾ç½®ç›¸åº”çš„SpecificRecord(avroçš„åºåˆ—åŒ–å’Œååºåˆ—åŒ–ç­‰..)
	2. æ¥æºä½¿ç”¨çš„Apiä¸ä¸€æ ·, streamçš„å‚æ•°æ²¡æœ‰æŒ‡å®škeyï¼Œvalueçš„ç±»å‹ï¼Œä¸ºä»€ä¹ˆå¯ä»¥ä¸æŒ‡å®šå‘¢ï¼Ÿ..å¾…å®šğŸ˜³    ```final KStream<String, WikiFeed> feeds = builder.stream(WikipediaFeedAvroExample.WIKIPEDIA_FEED);```
	
	3. æµå¼è®¡ç®—ä¸­ä½¿ç”¨äº†filter()å’Œmap, æ³¨æ„mapçš„è¿”å›å€¼ä¸ºkey-value,ç‚¹ä¸€ä¸‹ä¸Šé¢flatMapï¼Œ ç›´æ¥è¿”å›valueå³å¯ï¼Œ mapè¿”å›çš„åªæœ‰å­é›†åˆã€‚    ```.map((key, value) -> new KeyValue<>(value.getUser().toString(), value))```

+ WikipediaFeedAvroExampleDriverï¼Œ ä½œä¸ºä¸Šä¸ªä¾‹å­ä¸­Producer
+ WikipediaFeedAvroExampleï¼Œ è·Ÿä¹‹å‰çš„åŒºåˆ«æ˜¯åœ¨streamä¸­çš„å¤„ç†ç”¨çš„æ™®é€šå‡½æ•°è€Œä¸æ˜¯lambda
+ UserRegionLambdaExample, åŒæ ·æ˜¯è®¡æ•°ï¼Œç‰¹ç‚¹åœ¨äºå°†ç»Ÿè®¡å‡ºæ¥çš„ç»“æœä¿å­˜äºKTableä¸­ï¼Œ KTableå¯toStreamå†è¿›è¡Œè¾“å‡ºåˆ°topicä¸­


